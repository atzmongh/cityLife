
@using cityLife;
@using cityLife4;
@using cityLife.Controllers;
@{
    ViewBag.Title = "s25orderBooking";
    OrderData theOrderData = ViewBag.orderData;
    TranslateBox tBox = ViewBag.tBox;
    IEnumerable<short> theApartmentNumbers = ViewBag.apartmentNumbers;
}

<div class='field-box datepicker-box @theOrderData.errorOf("checkin")'>
    <input type="text" id="checkinDate" name="checkinDate" value='@theOrderData.checkin.ToString("dd MMM, yyyy")' onchange="bookingChanged(this)">
    <label for="checkinDate">
        <span class="field-name">@tBox.translate("Check-in date")</span>
        <span class="calendar-ico"></span>
    </label>
    <span class="field-error">@theOrderData.errorMessageOf("checkin", tBox)</span>
</div>
<div class="field-box datepicker-box">
    <input type="text" id="checkoutDate" name="checkoutDate" value='@theOrderData.checkout.ToString("dd MMM, yyyy")' onchange="bookingChanged(this)">
    <label for="checkoutDate">
        <span class="field-name">@tBox.translate("Check out date")</span>
        <span class="calendar-ico"></span>
    </label>
    <span class="field-error"></span>
    <span id="nights" class="nights">@theOrderData.nights @tBox.translate("nights")</span>
</div>
<div class="form-box-wrap">
    <div class="field-box select-box">
        <select id="adults" name="adults" onchange="bookingChanged(this)">
            @{
                for (int i = 1; i <= 4; i++)
                {
                    if (theOrderData.adults == i)
                    {
                        <option value="@i" selected>@i</option>
                    }
                    else
                    {
                        <option value="@i">@i</option>
                    }
                }
            }
        </select>
        <label>
            <span class="field-name">@tBox.translate("Guests")</span>
        </label>
    </div>
    <div class="field-box select-box">
        <select id="children" name="children" onchange="bookingChanged(this)">
            @{
                for (int i = 0; i <= 4; i++)
                {
                    if (theOrderData.children == i)
                    {
                        <option value="@i" selected>@i</option>
                    }
                    else
                    {
                        <option value="@i">@i</option>
                    }
                }
            }
        </select>
        <label>
            <span class="field-name">@tBox.translate("Children")</span>
        </label>
    </div>
</div>
<div class="form-box-wrap">


    <div class="field-box select-box">
        <select id="apartmentNumber" name="apartmentNumber" onchange="bookingChanged(this)">

            @foreach (int anApartmentNumber in theApartmentNumbers)
            {
                if (anApartmentNumber < 0)
                {
                    //This is a "waiting apartment" do not include it in the list of apartments
                    continue;
                }
                if (anApartmentNumber == theOrderData.apartmentNumber)
                {
                    <option value="@anApartmentNumber" selected>@anApartmentNumber</option>
                }
                else
                {
                    <option value="@anApartmentNumber">@anApartmentNumber</option>
                }
            }
            @*Add the "none" option which actually means a "waiting apartment"*@
            @{
                if (theOrderData.apartmentNumber <= 0)
                {
                    //The current apartment is a "waiting apartment" - select the "none" option. 
                    <option value="@theOrderData.apartmentNumber" selected>@tBox.translate("None")</option>
                }
                else
                {
                    //The order is assigned to a normal apartment - show the "none" option, but do not select it
                    <option value="-1">@tBox.translate("None")</option>
                }
            }
        </select>
        <label>
            <span class="field-name">@tBox.translate("Apartment")</span>
        </label>
    </div>

    <div class="field-box select-box">
        <select id="status" name="status" onchange="statusChanged(this)">
            @foreach (OrderStatus aStatus in Enum.GetValues(typeof(OrderStatus)))
            {
                string statusName = tBox.translate(aStatus.ToString());
                string selected = "";
                if (aStatus == theOrderData.status)
                {
                    selected = "selected";
                }
                <option value="@aStatus" @selected>@statusName</option>
            }
        </select>
        <label>
            <span class="field-name">@tBox.translate("Status")</span>
        </label>
    </div>

</div>
<div>
    <div class="form-box-wrap">
        @Html.inputField("price", theOrderData.price, theOrderData.errorMessageOf("price", tBox), tBox, style: "width:48%")
        @Html.inputField("paid", theOrderData.paid, theOrderData.errorMessageOf("paid", tBox), tBox, style: "width:48%")

    </div>
    <div class="form-box-wrap">
        <div class="field-box select-box">
            <select name="bookedBy">
                @foreach(BookedBy aBookedBy in Enum.GetValues(typeof(BookedBy)))
                {
                    string selected = "";
                    string bookedBy = aBookedBy.ToString();
                    if (bookedBy == theOrderData.bookedBy)
                    {
                        selected = "selected";
                    }
                    <option value="@bookedBy" @selected>@tBox.translate(bookedBy)</option>
                }
            </select>
            <label>
                <span class="field-name">@tBox.translate("Booked By")</span>
            </label>
        </div>
        @Html.inputField("confirmationNumber", theOrderData.confirmationNumber, theOrderData.errorMessageOf("confirmationNumber", tBox), tBox, style: "width:48%")
    </div>
    <btn class="btn" onclick="activate('Status')">@tBox.translate("Next")</btn>
    <br />
    <span style="color:red" id="notAvailable"></span>

</div>

<script>
    function bookingChanged(field) {
        var fieldId = field.id;
        
        $.ajaxSetup({ cache: false });
        var bookingParameters = {};
        bookingParameters.checkinDate = $("#checkinDate").val();
        bookingParameters.checkoutDate = $("#checkoutDate").val();
        bookingParameters.adults = $("#adults").val();
        bookingParameters.children = $("#children").val();
        bookingParameters.apartmentNumber = $("#apartmentNumber").val();
        bookingParameters.orderId = $("#orderId").val();

        $.getJSON("/staff/s27checkBookingPrice", bookingParameters).done(updatePrice);
    }

    function updatePrice(priceInfo) {
        if (priceInfo.availability == "AVAILABLE") {
            //Update the price and nights
            $("#nights").html(priceInfo.nights + " " + '@tBox.translate("nights")');
            $("#price").val(priceInfo.price)
            $("#notAvailable").text("");
        }
        else {
            $("#notAvailable").text('@tBox.translate("apartment is not available")');

        }
    }
</script>


